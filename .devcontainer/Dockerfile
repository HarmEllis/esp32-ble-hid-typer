# ESP32 BLE HID Typer â€” DevContainer Dockerfile
#
# Base: Microsoft devcontainer with Node.js 24 LTS (Debian Bookworm)
# Added: ESP-IDF v5.3 with toolchain for ESP32-S3
#
# This container is for building only. Flashing and serial monitoring
# happen via the browser (Web Serial API), so no USB passthrough is needed.

FROM mcr.microsoft.com/devcontainers/javascript-node:24-bookworm

ARG DEBIAN_FRONTEND=noninteractive

# --------------------------------------------------------------------------
# 1. Install ESP-IDF system prerequisites
#
# Based on the official Espressif IDF Docker image:
# https://github.com/espressif/esp-idf/blob/v5.3/tools/docker/Dockerfile
# --------------------------------------------------------------------------
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        bison \
        ca-certificates \
        ccache \
        check \
        curl \
        flex \
        git \
        gperf \
        lcov \
        libbsd-dev \
        libffi-dev \
        libncurses-dev \
        libusb-1.0-0-dev \
        make \
        ninja-build \
        tmux \
        ripgrep \
        python3 \
        python3-pip \
        python3-venv \
        unzip \
        wget \
        xz-utils \
        zip \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* \
    && update-alternatives --install /usr/bin/python python /usr/bin/python3 10

# --------------------------------------------------------------------------
# 2. Clone ESP-IDF v5.3 (shallow clone to save space)
# --------------------------------------------------------------------------
ENV IDF_PATH=/opt/esp/idf
ENV IDF_TOOLS_PATH=/opt/esp

RUN git clone --recursive \
        --depth=1 --shallow-submodules \
        -b v5.3 \
        https://github.com/espressif/esp-idf.git \
        ${IDF_PATH} \
    && git config --system --add safe.directory ${IDF_PATH}

# --------------------------------------------------------------------------
# 3. Install ESP-IDF toolchains (ESP32-S3 only)
# --------------------------------------------------------------------------
RUN : \
    && update-ca-certificates --fresh \
    && ${IDF_PATH}/tools/idf_tools.py --non-interactive install required --targets=esp32s3 \
    && ${IDF_PATH}/tools/idf_tools.py --non-interactive install cmake \
    && ${IDF_PATH}/tools/idf_tools.py --non-interactive install-python-env \
    && rm -rf ${IDF_TOOLS_PATH}/dist \
    && :

# --------------------------------------------------------------------------
# 4. Environment: make idf.py work without sourcing export.sh
#
# export.sh adds toolchain paths to PATH and sets Python env vars.
# We run it once, capture the resulting PATH, and persist it via
# /etc/bash.bashrc so every shell (interactive or not) inherits it.
#
# The Python constraint file has already been downloaded and the right
# package versions installed. No need to re-check at every invocation.
# --------------------------------------------------------------------------
ENV IDF_PYTHON_CHECK_CONSTRAINTS=no
ENV IDF_CCACHE_ENABLE=1

# Capture the full PATH that export.sh produces and persist it in
# three locations to cover all shell invocation modes:
#   /etc/bash.bashrc   - interactive bash shells (VS Code terminal)
#   /etc/profile.d/    - login shells (postCreateCommand, SSH)
#   /etc/environment   - PAM sessions
RUN IDF_EXPORT_PATH=$(bash -c '. ${IDF_PATH}/export.sh > /dev/null 2>&1 && echo $PATH') \
    && IDF_PYTHON_ENV=$(bash -c '. ${IDF_PATH}/export.sh > /dev/null 2>&1 && echo $IDF_PYTHON_ENV_PATH') \
    && { \
        echo ""; \
        echo "# ESP-IDF environment (auto-generated by Dockerfile)"; \
        echo "export IDF_PATH=\"${IDF_PATH}\""; \
        echo "export IDF_TOOLS_PATH=\"${IDF_TOOLS_PATH}\""; \
        echo "export IDF_PYTHON_CHECK_CONSTRAINTS=no"; \
        echo "export IDF_CCACHE_ENABLE=1"; \
        echo "export IDF_PYTHON_ENV_PATH=\"${IDF_PYTHON_ENV}\""; \
        echo "export PATH=\"${IDF_EXPORT_PATH}\""; \
    } | tee -a /etc/bash.bashrc > /etc/profile.d/esp-idf.sh \
    && chmod +x /etc/profile.d/esp-idf.sh \
    && echo "PATH=\"${IDF_EXPORT_PATH}\"" >> /etc/environment

# --------------------------------------------------------------------------
# 5. Permissions: make ESP-IDF tools accessible to the 'node' user
#
# The devcontainer base image runs as 'node' by default. ESP-IDF
# toolchains are installed under /opt/esp by root. We grant read
# and execute access so the node user can run idf.py and all tools.
# --------------------------------------------------------------------------
RUN chmod -R a+rX /opt/esp

# --------------------------------------------------------------------------
# 6. Install uv, claude-code-tools, and Claude Code CLI (as node user)
#
# uv: Python package manager (installs to ~/.local/bin)
# claude-code-tools: Provides tmux-cli and other Claude Code plugins
# Claude Code CLI: The claude command-line tool
# --------------------------------------------------------------------------
USER node

RUN curl -LsSf https://astral.sh/uv/install.sh | sh \
    && . $HOME/.local/bin/env \
    && uv tool install claude-code-tools

RUN curl -fsSL https://claude.ai/install.sh | bash

RUN npm install -g @openai/codex

USER root

# Ensure uv and claude binaries are on PATH for all users
RUN { \
        echo ""; \
        echo "# uv and Claude Code (auto-generated by Dockerfile)"; \
        echo "export PATH=\"/home/node/.local/bin:\$PATH\""; \
    } | tee -a /etc/bash.bashrc >> /etc/profile.d/claude-tools.sh \
    && chmod +x /etc/profile.d/claude-tools.sh
